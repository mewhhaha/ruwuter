// Generated from src/runtime/client.ts using
//   base64 -w0 src/runtime/client.ts
// Update alongside runtime changes to keep DOM tests in sync.

const CLIENT_RUNTIME_BASE64 =
  "dHlwZSBSZWZMaXN0ZW5lciA9ICgpID0+IHZvaWQ7Cgp0eXBlIEV2ZW50TGlzdGVuZXJPcHRpb25zID0gewogIGNhcHR1cmU/OiBib29sZWFuOwogIG9uY2U/OiBib29sZWFuOwogIHBhc3NpdmU/OiBib29sZWFuOwogIHByZXZlbnREZWZhdWx0PzogYm9vbGVhbjsKfTsKCnR5cGUgTW9kdWxlRW50cnkgPSB7CiAgdDogIm0iOwogIHM6IHN0cmluZzsKICB4Pzogc3RyaW5nOwogIGV2Pzogc3RyaW5nOwogIG9wdD86IEV2ZW50TGlzdGVuZXJPcHRpb25zOwp9OwoKdHlwZSBIeWRyYXRpb25QYXlsb2FkID0gewogIGJpbmQ/OiB1bmtub3duOwogIG9uPzogTW9kdWxlRW50cnlbXTsKfTsKCnR5cGUgQ2xpZW50Rm4gPSAodGhpczogdW5rbm93biwgZXY6IEV2ZW50LCBzaWduYWw6IEFib3J0U2lnbmFsKSA9PiB1bmtub3duOwoKaW50ZXJmYWNlIFJlZk9iamVjdCB7CiAgaWQ6IHN0cmluZzsKICBnZXQoKTogdW5rbm93bjsKICBzZXQobmV4dDogdW5rbm93biB8ICgocHJldjogdW5rbm93bikgPT4gdW5rbm93bikpOiB2b2lkOwogIHRvSlNPTigpOiB7IF9fcmVmOiB0cnVlOyBpOiBzdHJpbmc7IHY6IHVua25vd24gfTsKICB0b1N0cmluZygpOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBSZWZTdG9yZSB7CiAgc2V0KGlkOiBzdHJpbmcsIG5leHQ6IHVua25vd24gfCAoKHByZXY6IHVua25vd24pID0+IHVua25vd24pKTogdm9pZDsKICBnZXQoaWQ6IHN0cmluZyk6IHVua25vd247CiAgd2F0Y2goaWQ6IHN0cmluZywgZm46IFJlZkxpc3RlbmVyKTogKCkgPT4gdm9pZDsKICByZWYoaWQ6IHN0cmluZywgaW5pdGlhbDogdW5rbm93bik6IFJlZk9iamVjdDsKfQoKaW50ZXJmYWNlIEVsZW1lbnRDb250ZXh0IHsKICBiaW5kOiB1bmtub3duOwogIGNvbnRyb2xsZXJzOiBNYXA8c3RyaW5nLCBBYm9ydENvbnRyb2xsZXI+OwogIHVubW91bnQ6IE1vZHVsZUVudHJ5W107Cn0KCnR5cGUgTW9kdWxlTmFtZXNwYWNlID0gUmVjb3JkPHN0cmluZywgdW5rbm93bj47CgppbnRlcmZhY2UgR2xvYmFsQ2xpZW50V2luZG93IGV4dGVuZHMgV2luZG93IHsKICBfX3J1d3V0ZXI/OiB7CiAgICBzdG9yZT86IFJlZlN0b3JlOwogICAgbG9hZE1vZHVsZT86IChzcGVjOiBzdHJpbmcpID0+IFByb21pc2U8TW9kdWxlTmFtZXNwYWNlPjsKICB9Owp9CgppbnRlcmZhY2UgU3ludGhldGljRXZlbnRGYWN0b3J5IHsKICA8RSBleHRlbmRzIEV2ZW50PihldmVudDogRSk6IEU7CiAgW1N5bWJvbC5oYXNJbnN0YW5jZV0odmFsdWU6IHVua25vd24pOiBib29sZWFuOwp9Cgpjb25zdCBzeW50aGV0aWNFdmVudEluc3RhbmNlcyA9IG5ldyBXZWFrU2V0PEV2ZW50PigpOwpjb25zdCBzeW50aGV0aWNFdmVudENhY2hlID0gbmV3IFdlYWtNYXA8RXZlbnQsIEV2ZW50PigpOwoKY29uc3QgU3ludGhldGljRXZlbnQ6IFN5bnRoZXRpY0V2ZW50RmFjdG9yeSA9ICgoZXZlbnQ6IEV2ZW50KSA9PiB7CiAgaWYgKHN5bnRoZXRpY0V2ZW50Q2FjaGUuaGFzKGV2ZW50KSkgewogICAgcmV0dXJuIHN5bnRoZXRpY0V2ZW50Q2FjaGUuZ2V0KGV2ZW50KSE7CiAgfQoKICBjb25zdCBjdXJyZW50VGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCA/PyBudWxsOwogIGNvbnN0IHNyY0VsZW1lbnQgPQogICAgKCJzcmNFbGVtZW50IiBpbiBldmVudCA/IChldmVudCBhcyBFdmVudCAmIHsgc3JjRWxlbWVudD86IEV2ZW50VGFyZ2V0IHwgbnVsbCB9KS5zcmNFbGVtZW50IDogdW5kZWZpbmVkKSA/PwogICAgY3VycmVudFRhcmdldDsKICBjb25zdCBldmVudFBoYXNlID0gZXZlbnQuZXZlbnRQaGFzZTsKICBjb25zdCBjb21wb3NlZFBhdGggPSB0eXBlb2YgZXZlbnQuY29tcG9zZWRQYXRoID09PSAiZnVuY3Rpb24iCiAgICA/IGV2ZW50LmNvbXBvc2VkUGF0aCgpCiAgICA6IHVuZGVmaW5lZDsKCiAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkoZXZlbnQsIHsKICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKSB7CiAgICAgIGlmIChwcm9wID09PSAiY3VycmVudFRhcmdldCIpIHJldHVybiBjdXJyZW50VGFyZ2V0OwogICAgICBpZiAocHJvcCA9PT0gInNyY0VsZW1lbnQiKSByZXR1cm4gc3JjRWxlbWVudDsKICAgICAgaWYgKHByb3AgPT09ICJldmVudFBoYXNlIikgcmV0dXJuIGV2ZW50UGhhc2U7CiAgICAgIGlmIChwcm9wID09PSAiY29tcG9zZWRQYXRoIikgewogICAgICAgIHJldHVybiAoKSA9PiBjb21wb3NlZFBhdGggPyBjb21wb3NlZFBhdGguc2xpY2UoKSA6IFtdOwogICAgICB9CiAgICAgIGNvbnN0IHZhbHVlID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcik7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyB2YWx1ZS5iaW5kKHRhcmdldCkgOiB2YWx1ZTsKICAgIH0sCiAgfSk7CgogIHN5bnRoZXRpY0V2ZW50Q2FjaGUuc2V0KGV2ZW50LCBwcm94eSk7CiAgc3ludGhldGljRXZlbnRJbnN0YW5jZXMuYWRkKHByb3h5KTsKICByZXR1cm4gcHJveHk7Cn0pIGFzIFN5bnRoZXRpY0V2ZW50RmFjdG9yeTsKClN5bnRoZXRpY0V2ZW50W1N5bWJvbC5oYXNJbnN0YW5jZV0gPSAodmFsdWU6IHVua25vd24pOiBib29sZWFuID0+CiAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiBzeW50aGV0aWNFdmVudEluc3RhbmNlcy5oYXModmFsdWUgYXMgRXZlbnQpOwoKY29uc3QgaGFzV2luZG93ID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCI7CgpmdW5jdGlvbiBpbml0aWFsaXplQ2xpZW50UnVudGltZSgpOiB2b2lkIHsKICBpZiAoIWhhc1dpbmRvdykgcmV0dXJuOwogIGNvbnN0IGdsb2JhbFdpbmRvdyA9IHdpbmRvdyBhcyBHbG9iYWxDbGllbnRXaW5kb3c7CiAgaWYgKGdsb2JhbFdpbmRvdy5fX3J1d3V0ZXI/LnN0b3JlKSByZXR1cm47CiAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHJldHVybjsKCiAgY29uc3QgbG9hZE1vZHVsZSA9ICgoKSA9PiB7CiAgICBjb25zdCBjYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBQcm9taXNlPE1vZHVsZU5hbWVzcGFjZT4+KCk7CgogICAgY29uc3QgcmVzb2x2ZSA9IChzcGVjOiBzdHJpbmcpID0+IHsKICAgICAgaWYgKC9eW2EtekEtWl1bYS16QS1aMC05Ky4tXSo6Ly50ZXN0KHNwZWMpKSByZXR1cm4gc3BlYzsgLy8gYWxyZWFkeSBhYnNvbHV0ZSBVUkwKICAgICAgaWYgKHNwZWMuc3RhcnRzV2l0aCgiLyIpKSByZXR1cm4gbmV3IFVSTChzcGVjLCB3aW5kb3cubG9jYXRpb24ub3JpZ2luKS5ocmVmOwogICAgICAvLyBSZXNvbHZlIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IGRpcmVjdG9yeSwgbm90IHRyZWF0aW5nIHRoZSBsYXN0IHBhdGggc2VnbWVudCBhcyBhIGZpbGUKICAgICAgY29uc3QgYmFzZURpciA9IG5ldyBVUkwoIi4iLCB3aW5kb3cubG9jYXRpb24uaHJlZik7CiAgICAgIHJldHVybiBuZXcgVVJMKHNwZWMsIGJhc2VEaXIpLmhyZWY7CiAgICB9OwoKICAgIHJldHVybiAoc3BlYzogc3RyaW5nKSA9PiB7CiAgICAgIGNvbnN0IHJlc29sdmVkID0gcmVzb2x2ZShzcGVjKTsKICAgICAgaWYgKCFjYWNoZS5oYXMocmVzb2x2ZWQpKSB7CiAgICAgICAgY29uc3QgY3VzdG9tTG9hZGVyID0gZ2xvYmFsV2luZG93Ll9fcnV3dXRlcj8ubG9hZE1vZHVsZTsKICAgICAgICBjYWNoZS5zZXQoCiAgICAgICAgICByZXNvbHZlZCwKICAgICAgICAgIGN1c3RvbUxvYWRlciA/IGN1c3RvbUxvYWRlcihyZXNvbHZlZCkgOiBpbXBvcnQocmVzb2x2ZWQpLAogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlLmdldChyZXNvbHZlZCkhOwogICAgfTsKICB9KSgpOwoKICBjb25zdCBzdG9yZTogUmVmU3RvcmUgPSAoKCkgPT4gewogICAgY29uc3QgdmFsdWVzID0gbmV3IE1hcDxzdHJpbmcsIHVua25vd24+KCk7CiAgICBjb25zdCBsaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgU2V0PFJlZkxpc3RlbmVyPj4oKTsKICAgIGNvbnN0IHJlZnMgPSBuZXcgTWFwPHN0cmluZywgUmVmT2JqZWN0PigpOwoKICAgIGNvbnN0IGVuc3VyZSA9IChpZDogc3RyaW5nLCBpbml0aWFsOiB1bmtub3duKSA9PiB7CiAgICAgIGlmICghdmFsdWVzLmhhcyhpZCkpIHZhbHVlcy5zZXQoaWQsIGluaXRpYWwpOwogICAgICByZXR1cm4gdmFsdWVzLmdldChpZCk7CiAgICB9OwoKICAgIGNvbnN0IHNldCA9IChpZDogc3RyaW5nLCBuZXh0OiB1bmtub3duIHwgKChwcmV2OiB1bmtub3duKSA9PiB1bmtub3duKSkgPT4gewogICAgICBjb25zdCBjdXJyZW50ID0gdmFsdWVzLmdldChpZCk7CiAgICAgIGNvbnN0IHZhbHVlID0gdHlwZW9mIG5leHQgPT09ICJmdW5jdGlvbiIKICAgICAgICA/IChuZXh0IGFzIChwcmV2OiB1bmtub3duKSA9PiB1bmtub3duKShjdXJyZW50KQogICAgICAgIDogbmV4dDsKICAgICAgdmFsdWVzLnNldChpZCwgdmFsdWUpOwogICAgICBjb25zdCBzdWJzID0gbGlzdGVuZXJzLmdldChpZCk7CiAgICAgIGlmICghc3VicykgcmV0dXJuOwogICAgICBjb25zdCBzbmFwc2hvdCA9IEFycmF5LmZyb20oc3Vicyk7CiAgICAgIHNuYXBzaG90LmZvckVhY2goKGZuKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZuKCk7CiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAvKiBpZ25vcmUgc3Vic2NyaWJlciBlcnJvcnMgKi8KICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICBjb25zdCB3YXRjaCA9IChpZDogc3RyaW5nLCBmbjogUmVmTGlzdGVuZXIpID0+IHsKICAgICAgbGV0IHN1YnMgPSBsaXN0ZW5lcnMuZ2V0KGlkKTsKICAgICAgaWYgKCFzdWJzKSB7CiAgICAgICAgc3VicyA9IG5ldyBTZXQ8UmVmTGlzdGVuZXI+KCk7CiAgICAgICAgbGlzdGVuZXJzLnNldChpZCwgc3Vicyk7CiAgICAgIH0KICAgICAgc3Vicy5hZGQoZm4pOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIGNvbnN0IGJ1Y2tldCA9IGxpc3RlbmVycy5nZXQoaWQpOwogICAgICAgIGlmICghYnVja2V0KSByZXR1cm47CiAgICAgICAgYnVja2V0LmRlbGV0ZShmbik7CiAgICAgICAgaWYgKGJ1Y2tldC5zaXplID09PSAwKSBsaXN0ZW5lcnMuZGVsZXRlKGlkKTsKICAgICAgfTsKICAgIH07CgogICAgY29uc3QgY3JlYXRlUmVmID0gKGlkOiBzdHJpbmcsIGluaXRpYWw6IHVua25vd24pOiBSZWZPYmplY3QgPT4gewogICAgICBlbnN1cmUoaWQsIGluaXRpYWwpOwogICAgICBpZiAoIXJlZnMuaGFzKGlkKSkgewogICAgICAgIGNvbnN0IHJlZjogUmVmT2JqZWN0ID0gewogICAgICAgICAgaWQsCiAgICAgICAgICBnZXQ6ICgpID0+IHZhbHVlcy5nZXQoaWQpLAogICAgICAgICAgc2V0OiAobmV4dCkgPT4gc2V0KGlkLCBuZXh0KSwKICAgICAgICAgIHRvSlNPTjogKCkgPT4gKHsgX19yZWY6IHRydWUgYXMgY29uc3QsIGk6IGlkLCB2OiB2YWx1ZXMuZ2V0KGlkKSB9KSwKICAgICAgICAgIHRvU3RyaW5nOiAoKSA9PiBTdHJpbmcodmFsdWVzLmdldChpZCkpLAogICAgICAgIH07CiAgICAgICAgcmVmcy5zZXQoaWQsIHJlZik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlZnMuZ2V0KGlkKSE7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHNldCwKICAgICAgZ2V0OiAoaWQ6IHN0cmluZykgPT4gdmFsdWVzLmdldChpZCksCiAgICAgIHdhdGNoLAogICAgICByZWY6IGNyZWF0ZVJlZiwKICAgIH07CiAgfSkoKTsKCiAgY29uc3QgY29udGV4dHMgPSBuZXcgV2Vha01hcDxFbGVtZW50LCBFbGVtZW50Q29udGV4dD4oKTsKICBjb25zdCBoeWRyYXRlZCA9IG5ldyBTZXQ8c3RyaW5nPigpOwoKICBmdW5jdGlvbiByZXZpdmUoX2tleTogc3RyaW5nLCB2YWx1ZTogdW5rbm93bik6IHVua25vd24gewogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgY29uc3QgcmVjb3JkID0gdmFsdWUgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47CiAgICAgIGlmIChyZWNvcmQuX19yZWYgPT09IHRydWUgJiYgdHlwZW9mIHJlY29yZC5pID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnN0IGlkID0gcmVjb3JkLmk7CiAgICAgICAgY29uc3QgaW5pdGlhbCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChyZWNvcmQsICJ2IikgPyByZWNvcmQudiA6IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gc3RvcmUucmVmKGlkLCBpbml0aWFsKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VQYXlsb2FkKHRleHQ6IHN0cmluZyk6IEh5ZHJhdGlvblBheWxvYWQgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIChKU09OLnBhcnNlKHRleHQsIHJldml2ZSkgYXMgSHlkcmF0aW9uUGF5bG9hZCkgPz8ge307CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIHt9OwogICAgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUVudHJ5KGVudHJ5PzogTW9kdWxlRW50cnkpOiBQcm9taXNlPENsaWVudEZuIHwgdW5kZWZpbmVkPiB7CiAgICBpZiAoIWVudHJ5IHx8IGVudHJ5LnQgIT09ICJtIikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IG1vZCA9IGF3YWl0IGxvYWRNb2R1bGUoZW50cnkucyk7CiAgICBjb25zdCBjYW5kaWRhdGUgPSBlbnRyeS54ICYmIGVudHJ5LnggaW4gbW9kICYmIHR5cGVvZiBtb2RbZW50cnkueF0gPT09ICJmdW5jdGlvbiIKICAgICAgPyAobW9kW2VudHJ5LnhdIGFzIENsaWVudEZuKQogICAgICA6IHR5cGVvZiBtb2QuZGVmYXVsdCA9PT0gImZ1bmN0aW9uIgogICAgICA/IChtb2QuZGVmYXVsdCBhcyBDbGllbnRGbikKICAgICAgOiB0eXBlb2YgbW9kID09PSAiZnVuY3Rpb24iCiAgICAgID8gKG1vZCBhcyB1bmtub3duIGFzIENsaWVudEZuKQogICAgICA6IHVuZGVmaW5lZDsKICAgIHJldHVybiBjYW5kaWRhdGU7CiAgfQoKICBmdW5jdGlvbiBnZXRDb250ZXh0KGVsOiBFbGVtZW50KTogRWxlbWVudENvbnRleHQgewogICAgbGV0IGN0eCA9IGNvbnRleHRzLmdldChlbCk7CiAgICBpZiAoIWN0eCkgewogICAgICBjdHggPSB7CiAgICAgICAgYmluZDogdW5kZWZpbmVkLAogICAgICAgIGNvbnRyb2xsZXJzOiBuZXcgTWFwPHN0cmluZywgQWJvcnRDb250cm9sbGVyPigpLAogICAgICAgIHVubW91bnQ6IFtdLAogICAgICB9OwogICAgICBjb250ZXh0cy5zZXQoZWwsIGN0eCk7CiAgICB9CiAgICByZXR1cm4gY3R4OwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaW52b2tlRW50cnkoCiAgICBlbDogRWxlbWVudCwKICAgIGVudHJ5OiBNb2R1bGVFbnRyeSwKICAgIHR5cGU6IHN0cmluZywKICAgIGV2OiBFdmVudCwKICApOiBQcm9taXNlPHZvaWQ+IHsKICAgIGNvbnN0IGZuID0gYXdhaXQgcmVzb2x2ZUVudHJ5KGVudHJ5KTsKICAgIGlmICghZm4pIHJldHVybjsKICAgIGNvbnN0IGN0eCA9IGdldENvbnRleHQoZWwpOwogICAgY29uc3QgY29udHJvbGxlcnMgPSBjdHguY29udHJvbGxlcnM7CgogICAgaWYgKHR5cGUgPT09ICJ1bm1vdW50IikgewogICAgICBjb250cm9sbGVycy5mb3JFYWNoKChjdHJsKSA9PiBjdHJsLmFib3J0KCkpOwogICAgICBjb250cm9sbGVycy5jbGVhcigpOwogICAgfQoKICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBpZiAodHlwZSkgewogICAgICBjb250cm9sbGVycy5nZXQodHlwZSk/LmFib3J0KCk7CiAgICAgIGNvbnRyb2xsZXJzLnNldCh0eXBlLCBjb250cm9sbGVyKTsKICAgIH0KCiAgICB0cnkgewogICAgICBhd2FpdCBmbi5jYWxsKGN0eC5iaW5kID8/IGVsLCBldiwgY29udHJvbGxlci5zaWduYWwpOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmICgKICAgICAgICBjb250cm9sbGVyLnNpZ25hbC5hYm9ydGVkIHx8CiAgICAgICAgKGVyciBpbnN0YW5jZW9mIEVycm9yICYmIGVyci5uYW1lID09PSAiQWJvcnRFcnJvciIpCiAgICAgICkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICB9IGZpbmFsbHkgewogICAgICBpZiAodHlwZSAmJiBjb250cm9sbGVycy5nZXQodHlwZSkgPT09IGNvbnRyb2xsZXIpIHsKICAgICAgICBjb250cm9sbGVycy5kZWxldGUodHlwZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGF0dGFjaEhhbmRsZXIoZWw6IEVsZW1lbnQsIGVudHJ5OiBNb2R1bGVFbnRyeSk6IHZvaWQgewogICAgaWYgKCFlbnRyeSB8fCBlbnRyeS50ICE9PSAibSIpIHJldHVybjsKICAgIGNvbnN0IHR5cGUgPSBlbnRyeS5ldiAmJiBlbnRyeS5ldi5sZW5ndGggPiAwID8gZW50cnkuZXYgOiAiY2xpY2siOwoKICAgIGlmICh0eXBlID09PSAibW91bnQiKSB7CiAgICAgIHF1ZXVlTWljcm90YXNrKCgpID0+IGludm9rZUVudHJ5KGVsLCBlbnRyeSwgIm1vdW50IiwgbmV3IEV2ZW50KCJtb3VudCIpKSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25zdCBjdHggPSBnZXRDb250ZXh0KGVsKTsKICAgIGlmICh0eXBlID09PSAidW5tb3VudCIpIHsKICAgICAgY3R4LnVubW91bnQucHVzaChlbnRyeSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IGVudHJ5Lm9wdAogICAgICA/IHsKICAgICAgICBjYXB0dXJlOiBlbnRyeS5vcHQuY2FwdHVyZSwKICAgICAgICBvbmNlOiBlbnRyeS5vcHQub25jZSwKICAgICAgICBwYXNzaXZlOiBlbnRyeS5vcHQucGFzc2l2ZSwKICAgICAgfQogICAgICA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IHByZXZlbnREZWZhdWx0ID0gZW50cnkub3B0Py5wcmV2ZW50RGVmYXVsdCA9PT0gdHJ1ZSAmJiBlbnRyeS5vcHQucGFzc2l2ZSAhPT0gdHJ1ZTsKICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgKGV2ZW50KSA9PiB7CiAgICAgIGlmIChwcmV2ZW50RGVmYXVsdCAmJiBldmVudC5jYW5jZWxhYmxlKSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgICBjb25zdCBzeW50aGV0aWMgPSBTeW50aGV0aWNFdmVudChldmVudCk7CiAgICAgIHZvaWQgaW52b2tlRW50cnkoZWwsIGVudHJ5LCB0eXBlLCBzeW50aGV0aWMpOwogICAgfSwgbGlzdGVuZXJPcHRpb25zKTsKICB9CgogIGZ1bmN0aW9uIGh5ZHJhdGVQYXlsb2FkKGVsOiBFbGVtZW50LCBwYXlsb2FkOiBIeWRyYXRpb25QYXlsb2FkKTogdm9pZCB7CiAgICBpZiAoIXBheWxvYWQgfHwgdHlwZW9mIHBheWxvYWQgIT09ICJvYmplY3QiKSByZXR1cm47CiAgICBjb25zdCBjdHggPSBnZXRDb250ZXh0KGVsKTsKCiAgICBpZiAoImJpbmQiIGluIHBheWxvYWQpIHsKICAgICAgY3R4LmJpbmQgPSBwYXlsb2FkLmJpbmQ7CiAgICB9CgogICAgcGF5bG9hZC5vbj8uZm9yRWFjaCgoZW50cnkpID0+IGF0dGFjaEhhbmRsZXIoZWwsIGVudHJ5KSk7CiAgfQoKICBmdW5jdGlvbiBmaW5kSHlkcmF0aW9uRWxlbWVudChzY3JpcHQ6IEhUTUxTY3JpcHRFbGVtZW50KTogRWxlbWVudCB8IG51bGwgewogICAgY29uc3QgaWQgPSBzY3JpcHQuZ2V0QXR0cmlidXRlKCJkYXRhLWh5ZHJhdGUiKSA/PyAiIjsKICAgIGlmICghaWQpIHJldHVybiBudWxsOwoKICAgIGxldCBub2RlOiBDaGlsZE5vZGUgfCBudWxsID0gc2NyaXB0LnByZXZpb3VzU2libGluZzsKICAgIHdoaWxlIChub2RlKSB7CiAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgewogICAgICAgIHJldHVybiBub2RlIGFzIEVsZW1lbnQ7CiAgICAgIH0KICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IE5vZGUuQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgY29uc3QgY29tbWVudCA9IG5vZGUgYXMgQ29tbWVudDsKICAgICAgICBpZiAoY29tbWVudC5kYXRhID09PSBgL3J3Omg6JHtpZH1gIHx8IGNvbW1lbnQuZGF0YSA9PT0gYC9oeWRyYXRpb24tYm91bmRhcnk6JHtpZH1gKSB7CiAgICAgICAgICBsZXQgcHJldjogQ2hpbGROb2RlIHwgbnVsbCA9IGNvbW1lbnQucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgd2hpbGUgKHByZXYgJiYgcHJldi5ub2RlVHlwZSAhPT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHByZXYgJiYgcHJldi5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIHByZXYgYXMgRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGNvbW1lbnQuZGF0YSA9PT0gYGh5ZHJhdGlvbi1ib3VuZGFyeToke2lkfWApIHsKICAgICAgICAgIGxldCBuZXh0OiBDaGlsZE5vZGUgfCBudWxsID0gY29tbWVudC5uZXh0U2libGluZzsKICAgICAgICAgIHdoaWxlIChuZXh0ICYmIG5leHQubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHQgJiYgbmV4dC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG5leHQgYXMgRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBmdW5jdGlvbiBoeWRyYXRlU2NyaXB0KHNjcmlwdDogSFRNTFNjcmlwdEVsZW1lbnQpOiB2b2lkIHsKICAgIGNvbnN0IGlkID0gc2NyaXB0LmdldEF0dHJpYnV0ZSgiZGF0YS1oeWRyYXRlIikgPz8gIiI7CiAgICBpZiAoIWlkIHx8IGh5ZHJhdGVkLmhhcyhpZCkpIHJldHVybjsKCiAgICBjb25zdCBlbCA9IGZpbmRIeWRyYXRpb25FbGVtZW50KHNjcmlwdCk7CiAgICBpZiAoIWVsKSByZXR1cm47CgogICAgY29uc3QgcGF5bG9hZCA9IHBhcnNlUGF5bG9hZChzY3JpcHQudGV4dENvbnRlbnQgPz8gInt9Iik7CiAgICBoeWRyYXRlUGF5bG9hZChlbCwgcGF5bG9hZCk7CiAgICBoeWRyYXRlZC5hZGQoaWQpOwogIH0KCiAgZnVuY3Rpb24gdGVhcmRvd25FbGVtZW50KGVsOiBFbGVtZW50KTogdm9pZCB7CiAgICBjb25zdCBjdHggPSBjb250ZXh0cy5nZXQoZWwpOwogICAgaWYgKCFjdHgpIHJldHVybjsKCiAgICBjdHguY29udHJvbGxlcnMuZm9yRWFjaCgoY3RybCkgPT4gY3RybC5hYm9ydCgpKTsKICAgIGN0eC5jb250cm9sbGVycy5jbGVhcigpOwoKICAgIGlmIChjdHgudW5tb3VudC5sZW5ndGgpIHsKICAgICAgY3R4LnVubW91bnQuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgICB2b2lkIGludm9rZUVudHJ5KGVsLCBlbnRyeSwgInVubW91bnQiLCBuZXcgRXZlbnQoInVubW91bnQiKSk7CiAgICAgIH0pOwogICAgICBjdHgudW5tb3VudC5sZW5ndGggPSAwOwogICAgfQoKICAgIGNvbnRleHRzLmRlbGV0ZShlbCk7CiAgfQoKICBjb25zdCBpc0h5ZHJhdGlvblNjcmlwdCA9IChub2RlOiBOb2RlKTogbm9kZSBpcyBIVE1MU2NyaXB0RWxlbWVudCA9PgogICAgbm9kZSBpbnN0YW5jZW9mIEhUTUxTY3JpcHRFbGVtZW50ICYmCiAgICAobm9kZS5nZXRBdHRyaWJ1dGUoInR5cGUiKSB8fCAiIikudG9Mb3dlckNhc2UoKSA9PT0gImFwcGxpY2F0aW9uL2pzb24iICYmCiAgICBub2RlLmhhc0F0dHJpYnV0ZSgiZGF0YS1oeWRyYXRlIik7CgogIGZ1bmN0aW9uIHNlZWQoKTogdm9pZCB7CiAgICBkb2N1bWVudAogICAgICAucXVlcnlTZWxlY3RvckFsbCgnc2NyaXB0W3R5cGU9ImFwcGxpY2F0aW9uL2pzb24iXVtkYXRhLWh5ZHJhdGVdJykKICAgICAgLmZvckVhY2goKG5vZGUpID0+IGh5ZHJhdGVTY3JpcHQobm9kZSBhcyBIVE1MU2NyaXB0RWxlbWVudCkpOwogIH0KCiAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zKSA9PiB7CiAgICBmb3IgKGNvbnN0IG11dGF0aW9uIG9mIG11dGF0aW9ucykgewogICAgICBtdXRhdGlvbi5hZGRlZE5vZGVzPy5mb3JFYWNoKChub2RlKSA9PiB7CiAgICAgICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIEVsZW1lbnQpKSByZXR1cm47CiAgICAgICAgaWYgKGlzSHlkcmF0aW9uU2NyaXB0KG5vZGUpKSB7CiAgICAgICAgICBoeWRyYXRlU2NyaXB0KG5vZGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBub2RlCiAgICAgICAgICAucXVlcnlTZWxlY3RvckFsbCgnc2NyaXB0W3R5cGU9ImFwcGxpY2F0aW9uL2pzb24iXVtkYXRhLWh5ZHJhdGVdJykKICAgICAgICAgIC5mb3JFYWNoKChzY3JpcHQpID0+IGh5ZHJhdGVTY3JpcHQoc2NyaXB0IGFzIEhUTUxTY3JpcHRFbGVtZW50KSk7CiAgICAgIH0pOwoKICAgICAgbXV0YXRpb24ucmVtb3ZlZE5vZGVzPy5mb3JFYWNoKChub2RlKSA9PiB7CiAgICAgICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIEVsZW1lbnQpKSByZXR1cm47CiAgICAgICAgdGVhcmRvd25FbGVtZW50KG5vZGUpOwogICAgICAgIG5vZGUucXVlcnlTZWxlY3RvckFsbCgiKiIpLmZvckVhY2goKGNoaWxkKSA9PiB7CiAgICAgICAgICB0ZWFyZG93bkVsZW1lbnQoY2hpbGQpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgc2VlZCgpOwogIG9ic2VydmVyLm9ic2VydmUoZG9jdW1lbnQsIHsgY2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlIH0pOwoKICBnbG9iYWxXaW5kb3cuX19ydXd1dGVyID0gT2JqZWN0LmFzc2lnbihnbG9iYWxXaW5kb3cuX19ydXd1dGVyID8/IHt9LCB7CiAgICBzdG9yZSwKICB9KTsKfQoKaWYgKGhhc1dpbmRvdykgewogIGluaXRpYWxpemVDbGllbnRSdW50aW1lKCk7Cn0KCmV4cG9ydCB7fTsK"

let instance = 0;

export const nextClientRuntimeUrl = () =>
  `data:application/typescript;base64,${CLIENT_RUNTIME_BASE64}#${instance++}`;
